---
title: "Network-based models"
output: html_document
params:
  seed: 2024
  prop: 0.8
  folds: 10
  string_cutoff: 400
  min_degree: 0.3
  s: "lambda.min"
  alpha: 0.5
  parallel: TRUE
---

```{r, eval=FALSE, include=FALSE}
string_cutoff <- c(300, 400, 500, 600, 700)
alpha <- c(0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9)

dir.create("Results/reports", showWarnings = FALSE)
purrr::walk(string_cutoff, \(x) {
  purrr::walk(alpha, \(y) {
    rmarkdown::render(
      "network.Rmd", 
      output_file = glue::glue("Results/reports/network_{x}_{y}.html"), 
      params = list(string_cutoff = x, alpha = y, parallel = FALSE))
  })
})
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval=FALSE, include=FALSE}
renv::install("sysbiomed/glmSparseNet")
```

##### Load functions to enviroment / init options

```{r}
box::use(
  # Auxiliary functions used often (others use double colon)
  dplyr[select, left_join],
  logger[log_info, log_warn, log_fatal],
  cli[cli_alert_info, cli_alert_danger, cli_alert_warning, cli_alert_success],
  tictoc[tic, toc],
  
  # Custom functons for network operations
  ./Functions/network_utils[
    string_db_homo_sapiens, string_db_local_cache, my_plot, 
    calculate.combined.score_cache, buildStringNetwork_cache, memoise_cache
  ],
)

# Parallel cv.glmnet
doMC::registerDoMC(cores = 5)
logger::log_layout(logger::layout_glue_colors)
logger::log_appender(logger::appender_tee("logger_network.txt"))

glmnet_cache <- memoise::memoise(glmnet::glmnet, cache = memoise_cache)
```

## Read data

```{r}
.raw_gene <- feather::read_feather("Results/genes_expression.feather")
.raw_surv <- feather::read_feather("Results/survival_data.feather")

# Data structures
data <- list(
  raw = left_join(.raw_surv, .raw_gene, by = "patient")
)

colnames(data$raw) <- data$raw |> colnames() |> stringr::str_replace("[.][0-9]+$", "")
models <- list()
```

### Split data

```{r}
set.seed(params$seed)
data$split <- rsample::initial_split(data$raw, prop = params$prop, strata = "vital_status")
data$train <- list(raw = rsample::training(data$split))
data$test <- list(raw = rsample::testing(data$split))
```

### Build networks

#### Correlation from training data

```{r}
# data$cor <- glmSparseNet:::run.cache(
#   glmSparseNet::networkCorParallel, 
#   xdata = data$train$raw |>
#     dplyr::select(-patient, -vital_status, -days) |> 
#     as.matrix(),
#   n.cores = params$n.cores
# ) |> 
#   abs()
```


#### Build PPI network

```{r ppi_network}
data$ppi <- local({
  string_db_homo_sapiens()
  ppi_raw <- string_db_local_cache()
  ppi_data <- calculate.combined.score_cache(ppi_raw, score_threshold = params$string_cutoff, remove.text = TRUE)
  
  buildStringNetwork_cache(ppi_data, "ensembl")
})
```

Fill in the blanks of non-existing genes in (filtered) StringDB.

```{r fill_ppi}
data$full_ppi <- local({
  different_names <- colnames(data$raw)[
    !colnames(data$raw) %in% 
      c("patient", "vital_status", "days", colnames(data$ppi))
  ]
  new_size <- length(different_names) + ncol(data$ppi)
  full_ppi <- Matrix::sparseMatrix(
    i = c(), 
    j = c(), 
    x = numeric(0L),
    dims = c(new_size, new_size)
  )
  full_ppi[seq_len(nrow(data$ppi)), seq_len(ncol(data$ppi))] <- data$ppi != 0
  colnames(full_ppi) <- c(colnames(data$ppi), different_names)
  rownames(full_ppi) <- colnames(full_ppi)
  
  gene_names_original <- data$raw |> 
    colnames() |>
    purrr::discard(~.x %in% c("patient", "vital_status", "days"))
  
  # Return original order of data$raw
  full_ppi[gene_names_original, gene_names_original]
})
```


### Prepare `xdata` & `ydata`

```{r}
data$train$xdata <- data$train$raw |>
  select(-patient, -vital_status, -days) |> 
  as.matrix()

data$train$ydata <- data$train$raw |> 
  select(vital_status, days) |> 
  (\(x) survival::Surv(x$days, x$vital_status))()
```

#### Create folds for k-fold cross-validation

```{r}
data$train$foldid <- local({
  set.seed(params$seed - 100)
  folds <- rsample::vfold_cv(data$train$raw, v = params$folds, strata = "vital_status")
  unlist(
    lapply(
      folds$splits,
      \(x) {
        setNames(
          setdiff(seq_len(nrow(data$train$raw)), x$in_id), 
          rep(gsub("Fold", "", x$id) |> as.numeric(), nrow(data$train$raw) - length(x$in_id))
        )
      }
    )
  ) |> 
    sort() |> 
    names() |> 
    as.numeric()
})
```

## Train models

### GLMNET

#### Lasso

```{r lasso}
cli_alert_info("Training model for 'LASSO'...")
tic()
models$lasso <- glmnet::cv.glmnet(
  data$train$xdata,
  data$train$ydata,
  #
  alpha = 1,
  family = "cox",
  parallel = params$parallel,
  foldid = data$train$foldid
)
cli_alert_success("Model trained in {toc(quiet = TRUE)$callback_msg}")
attr(models$lasso, "alpha") <- 1
attr(models$lasso, "penalty") <- NULL
attr(models$lasso, "covariates") <- colnames(data$train$xdata)
attr(models$lasso, "label") <- "lasso"
gc(FALSE)
my_plot(models$lasso)
```

#### EN (0.8)

```{r en_8}
cli_alert_info("Training model for 'EN (0.8)'...")
tic()
models$en_0_8 <- glmnet::cv.glmnet(
  data$train$xdata,
  data$train$ydata,
  alpha = .8,
  #
  family = "cox",
  parallel = params$parallel,
  foldid = data$train$foldid
)
cli_alert_success("Model trained in {toc(quiet = TRUE)$callback_msg}")
attr(models$en_0_8, "alpha") <- 0.8
attr(models$en_0_8, "penalty") <- NULL
attr(models$en_0_8, "covariates") <- colnames(data$train$xdata)
attr(models$en_0_8, "label") <- "Elastic net (0.8)"
gc(FALSE)
my_plot(models$en_0_8)
```

#### EN (0.5)

```{r en_5}
cli_alert_info("Training model for 'EN (0.5)'...")
tic()
models$en_0_5 <- glmnet::cv.glmnet(
  data$train$xdata,
  data$train$ydata,
  alpha = .5,
  #
  family = "cox",
  parallel = params$parallel,
  foldid = data$train$foldid
)
cli_alert_success("Model trained in {toc(quiet = TRUE)$callback_msg}")
attr(models$en_0_5, "alpha") <- 0.5
attr(models$en_0_5, "penalty") <- NULL
attr(models$en_0_5, "covariates") <- colnames(data$train$xdata)
attr(models$en_0_5, "label") <- "Elastic net (0.5)"
gc(FALSE)
my_plot(models$en_0_5)
```

### glmSparseNet

- Prepares data explicitly

```{r}
data$covariates <- list(
  orphan = colnames(data$full_ppi),
  orphan_partial = intersect(colnames(data$ppi), colnames(data$raw)),
  hub = colnames(data$full_ppi),
  hub_partial = intersect(colnames(data$ppi), colnames(data$raw))
)

data$penalty <- local({
  calc_penalty <- \(x, fun, min_degree = params$min_degree) fun(Matrix::colSums(x) + Matrix::rowSums(x)) + min_degree
 
  partial_covariates <- data$covariates$orphan_partial
  list(
    orphan = calc_penalty(data$full_ppi, glmSparseNet::orphanHeuristic),
    orphan_partial = calc_penalty(data$full_ppi[partial_covariates, partial_covariates], glmSparseNet::orphanHeuristic),
    hub = calc_penalty(data$full_ppi, glmSparseNet::hubHeuristic),
    hub_partial = calc_penalty(data$full_ppi[partial_covariates, partial_covariates], glmSparseNet::hubHeuristic)
  )
})
```

### Histogram of penalties' distribution

```{r}
penalty_plot_data <- data$penalty |> 
  purrr::imap(\(x, i) tibble::tibble(penalty = x, network = i)) |> 
  purrr::list_rbind()
```

```{r}
penalty_plot_data |> 
  ggplot2::ggplot() +
  ggplot2::geom_histogram(ggplot2::aes(x = penalty, fill = network), binwidth = .5, alpha = 0.5, na.rm = TRUE) +
  ggplot2::scale_y_continuous(trans = "log10") +
  ggplot2::ylab("(log10)") +
  ggplot2::theme_minimal()
```

```{r}
penalty_plot_data |> 
  ggplot2::ggplot() +
  ggplot2::geom_density(ggplot2::aes(x = penalty, fill = network), alpha = 0.5, kernel = "rectangular") +
  ggplot2::scale_x_continuous(trans = "log10") +
  ggplot2::xlab("penalty (log10)") +
  ggplot2::facet_grid(cols = ggplot2::vars(network), scales = "free") + 
  ggplot2::theme_minimal()
```

#### Network models

```{r network_models}
new_models <- purrr::map(
  rlang::set_names(c("hub", "hub_partial", "orphan", "orphan_partial")),
  \(ix) {
    cli_alert_info("Training model for '{ix}'...")
    tic()
    new_model <- glmnet::cv.glmnet(
      data$train$xdata[, data$covariates[[ix]]],
      data$train$ydata,
      penalty = data$penalty[[ix]],
      alpha = params$alpha,
      family = "cox",
      foldid = data$train$foldid,
      parallel = params$parallel
    )
    gc(FALSE)
    attr(new_model, "alpha") <- params$alpha
    attr(new_model, "penalty") <- data$penalty[[ix]]
    attr(new_model, "covariates") <- data$covariates[[ix]]
    attr(new_model, "label") <- gsub("_", " ", ix) |> 
      tools::toTitleCase() |> 
      stringr::str_replace("Partial", "(partial)")
    
    cli_alert_success("Model trained in {toc(quiet = TRUE)$callback_msg}")
    new_model
  }
)

models <- Reduce(
  x = names(new_models),
  f = \(u, x) {
    u[[x]] <- new_models[[x]]
    u
  },
  init = models
)
  
```

```{r}
purrr::walk(new_models, ~my_plot(.x))
```

## Test

```{r}
data$test$xdata <- data$test$raw |>
  dplyr::select(-patient, -vital_status, -days) |> 
  as.matrix()

data$test$ydata <- data$test$raw |> 
  dplyr::select(vital_status, days) |> 
  (\(x) survival::Surv(x$days, x$vital_status))()
```

### C-Index

```{r}
results <- purrr::map(
  rlang::set_names(names(models)),
  \(x) {
    fit <- models[[x]]
    covariates <- attr(fit, "covariates")
    prob_test <- stats::predict(fit, newx = data$test$xdata[, covariates], s = "lambda.min", type = "response")
    c_index <- survival::concordance(data$test$ydata ~ prob_test, reverse=TRUE)$concordance
    
    risk_scores <- stats::predict(fit, newx = data$test$xdata[, covariates], s = "lambda.min", type = "link")
    risk_group <- ifelse(risk_scores > median(risk_scores), "High", "Low")
    
    log_rank_result <- if (length(unique(risk_group)) == 2L) {
      survival::survdiff(data$test$ydata ~ risk_group) 
    } else {
      list(pvalue = 1)
    }
    
    tibble::tibble(model = x, label = attr(fit, "label"), c_index = c_index, log_rank_pvalue = log_rank_result$pvalue)
  }
) |> 
  purrr::list_rbind()
```

```{r}
results
```

```{r}
results |> 
  dplyr::mutate(label = sprintf("%s\n(p: %.3f, c: %.3f)", label, log_rank_pvalue, c_index)) |>
  ggplot2::ggplot(ggplot2::aes(x = c_index, y = log_rank_pvalue, label = label)) +
  ggrepel::geom_text_repel(min.segment.length = .2, segment.color = "gray") + 
  ggplot2::geom_point() +
  ggplot2::xlim(0,1) + 
  ggplot2::ylim(0, 1) +
  ggplot2::xlab("C-Index") +
  ggplot2::ylab("Log-rank p-value") +
  ggplot2::geom_hline(yintercept = 0.05, linetype = "dashed", color = "red", alpha = .4) +
  ggplot2::annotate("text", x = 0, y = 0.045, label = "p-value ≤ 0.05", hjust = 0, vjust = 1, color = "red", alpha = .4) +
  ggplot2::theme_minimal()
```
```


















